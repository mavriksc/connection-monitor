<!DOCTYPE html>
<html>
<head>
    <title>Connection tester</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="graph"></div>
<div style="padding-left: 5%">
    <h2>Log Files</h2>
    <div id="logURLs">
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>

<script>
  const socket = io();
  let hs;

  function createPlot() {
    const data = [];
    hs.forEach(host => {
      const time = new Date();
      const traceData = {
        x: [time],
        y: [0],
        name: host,
        mode: 'lines',
      }
      data.push(traceData);
    });
    Plotly.plot('graph', data);
  }

  function updatePlot(host, response) {
    const update = {
      x: [[new Date(response.time)]],
      y: [[response.ping]]
    };
    Plotly.extendTraces('graph', update, [hs.indexOf(host)])

  }

  socket.on('hosts', function (hosts) {
    hs = hosts;
    createPlot()
    hs.forEach(function (host) {
      console.log(host);
      socket.on(host, function (msg) {
        const response = JSON.parse(msg);
        updatePlot(host, response);
      });
    });
  });

  socket.on('files', function (files) {
    updateLogFileURLS(files);
  });

  function updateLogFileURLS(files) {
    //TODO get element delete children then add children
    console.log(files);
    const logURLsUL = document.getElementById('logURLs');
    logURLsUL.innerHTML = '';
    files.forEach(file => {
      const p = document.createElement('p');
      const a = document.createElement('a');
      a.innerText = file;
      a.href = `/${file}`;
      p.appendChild(a);
      logURLsUL.appendChild(p);
    });
  }


</script>
</body>
</html>
