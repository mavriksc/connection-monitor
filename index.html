<!DOCTYPE html>
<html>
<head>
    <title>Connection tester</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/template.js"></script>
    <style>
        a { color:darkcyan }
        a:visited { color:darkmagenta }
    </style>
</head>
<body style="background: #111111">
<div id="graph"></div>
<div style="padding-left: 5%">
    <h2 style="color: lightseagreen">Log Files</h2>
    <div id="logURLs">
    </div>
</div>
<script>
  const socket = io();
  let hs;

  function createPlot(historicalData) {
    const data = [];
    hs.forEach((host, index) => {
      const xs = [];
      const ys = [];

      historicalData[index].forEach(pair => {
        xs.push(new Date(pair[0]));
        ys.push(pair[1])
      });
      const traceData = {
        x: xs,
        y: ys,
        name: host,
        mode: 'lines',
      }
      data.push(traceData);
    });
    Plotly.plot('graph', data,{template: template});
  }

  function updatePlot(host, response) {
    const update = {
      x: [[new Date(response.time)]],
      y: [[response.ping]]
    };
    Plotly.extendTraces('graph', update, [hs.indexOf(host)])

  }

  socket.on('hosts', function (hosts) {
    hs = hosts;
    hs.forEach(function (host) {
      socket.on(host, function (msg) {
        const response = JSON.parse(msg);
        updatePlot(host, response);
      });
    });
  });

  socket.on('historicalData', function (historicalData) {
    createPlot(historicalData);
  });

  socket.on('files', function (files) {
    const logURLsUL = document.getElementById('logURLs');
    logURLsUL.innerHTML = '';
    files.forEach(file => {
      const p = document.createElement('p');
      const a = document.createElement('a');
      a.innerText = file;
      a.href = `/${file}`;
      p.appendChild(a);
      logURLsUL.appendChild(p);
    });
  });

</script>
</body>
</html>
